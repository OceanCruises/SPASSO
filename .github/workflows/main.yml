name: Run code on multiple OS (Linux, macOS, Windows)

on:
  push:
    branches: [ main ]

jobs:
  Run-on-Ubuntu:
    name: Run code on Ubuntu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev hdf5-tools libnetcdf-dev netcdf-bin

      - name: Install numpy first
        run: pip install --upgrade pip setuptools wheel numpy

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Show Directory Structure
        run: pwd && ls -R

      - name: Ensure script is executable
        run: chmod +x ./src/Spasso.py

      - name: Debug PYTHONPATH
        run: echo $PYTHONPATH

      - name: Run with verbose debugging
        run: set -x && cd src && python -X dev -u Spasso.py WMedSeaExample

  Run-on-macOS:
    name: Run code on macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniforge (Conda)
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniforge-version: "latest"
          auto-update-conda: true
          python-version: "3.11"
          channels: conda-forge
          activate-environment: test-env

      - name: Fully Reset Conda Environment
        shell: bash -l {0}
        run: |
          conda deactivate || echo "No active env"
          conda remove --name test-env --all --yes || echo "Env does not exist"

      - name: Create or Update Conda Environment
        shell: bash -l {0}
        run: |
          conda env create -f environment.yml || conda env update --file environment.yml --prune

      - name: Activate Conda environment
        shell: bash -l {0}
        run: |
          source $(conda info --base)/etc/profile.d/conda.sh
          conda activate test-env
          conda info --envs  # Debugging

      - name: Run script
        shell: bash -l {0}
        run: |
          source $(conda info --base)/etc/profile.d/conda.sh
          conda activate test-env
          cd src
          python -X dev -u Spasso.py WMedSeaExample

  Run-on-Windows:
    name: Run code on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: "3.11"
          channels: conda-forge
          activate-environment: test-env

      - name: Ensure Conda is initialized
        shell: bash -l {0}
        run: |
          eval "$(${CONDA}/condabin/conda.bat shell.bash hook)"
          conda init bash

      - name: Fully Reset Conda Environment (Fixes 'prefix already exists' issue)
        shell: bash -l {0}
        run: |
          eval "$(${CONDA}/condabin/conda.bat shell.bash hook)"
          conda deactivate || echo "No active env"
          conda env remove --name test-env --yes || echo "No existing environment"

      - name: Create or Update Conda Environment
        shell: bash -l {0}
        run: |
          eval "$(${CONDA}/condabin/conda.bat shell.bash hook)"
          conda env create -f environment.yml || echo "Environment exists, updating..."
          conda env update --name test-env --file environment.yml --prune

      - name: Activate and Debug Environment
        shell: bash -l {0}
        run: |
          eval "$(${CONDA}/condabin/conda.bat shell.bash hook)"
          conda activate test-env
          conda list
          python -m pip list
          python -c "import numpy; print('numpy version:', numpy.__version__)"

      - name: Manually Clear Old Python Caches (Fixes 'Failed to remove contents' warning)
        shell: bash -l {0}
        run: |
          rm -rf C:/Miniconda/envs/test-env/Lib/site-packages/~umpy
          rm -rf C:/Miniconda/envs/test-env/Lib/site-packages/~atplotlib

      - name: Run script
        shell: bash -l {0}
        run: |
          eval "$(${CONDA}/condabin/conda.bat shell.bash hook)"
          conda activate test-env
          cd src
          python -X dev -u Spasso.py WMedSeaExample

