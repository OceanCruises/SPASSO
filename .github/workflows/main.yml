name: Run code on multiple OS (Linux, macOS, Windows)

on:
  push:
    branches: [ main ]

jobs:
  Run-on-Ubuntu:
    name: Run code on Ubuntu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libhdf5-dev hdf5-tools libnetcdf-dev netcdf-bin

      - name: Install numpy first
        run: pip install --upgrade pip setuptools wheel numpy

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # ðŸ” Show directory structure
      - name: Show Directory Structure
        run: pwd && ls -R

      # ðŸ” Ensure script is executable
      - name: Ensure script is executable
        run: chmod +x ./src/Spasso.py

      # ðŸ” Show Python path
      - name: Debug PYTHONPATH
        run: echo $PYTHONPATH

      # âœ… Run with verbose debugging
      - name: Debug Execution
        run: set -x && cd src && python -X dev -u Spasso.py WMedSeaExample

  Run-on-macOS:
    name: Run code on macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # âœ… Install system dependencies required for netCDF4
      - name: Install system dependencies
        run: |
          brew install hdf5 netcdf
          echo "HDF5_DIR=$(brew --prefix hdf5)" >> $GITHUB_ENV
          echo "NETCDF4_DIR=$(brew --prefix netcdf)" >> $GITHUB_ENV
          export HDF5_DIR=$(brew --prefix hdf5)
          export NETCDF4_DIR=$(brew --prefix netcdf)
          export CPATH=$(brew --prefix hdf5)/include:$CPATH
          export LIBRARY_PATH=$(brew --prefix hdf5)/lib:$LIBRARY_PATH
          export LD_LIBRARY_PATH=$(brew --prefix hdf5)/lib:$LD_LIBRARY_PATH

      # âœ… Upgrade pip and install build tools
      - name: Upgrade pip and install build tools
        run: pip install --upgrade pip setuptools wheel Cython numpy

      # âœ… Install all Python dependencies, including netCDF4
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # âœ… Run the script
      - name: Debug Execution
        run: |
          cd src
          python -X dev -u Spasso.py WMedSeaExample

  Run-on-Windows:
    name: Run code on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # âœ… Upgrade pip separately first
      - name: Upgrade pip separately
        run: python -m pip install --upgrade pip

      # âœ… Install numpy first
      - name: Install numpy first
        run: pip install --upgrade setuptools wheel numpy

      # âœ… Install Windows dependencies for netCDF4 (if needed)
      - name: Install Windows dependencies
        run: choco install netcdf hdf5

      # âœ… Install all other dependencies
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # âœ… Run the script
      - name: Debug Execution
        shell: bash
        run: |
          cd src
          python -X dev -u Spasso.py WMedSeaExample
